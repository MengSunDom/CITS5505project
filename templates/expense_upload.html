{% extends "base.html" %}
{% block title %}Upload Expenses - Expense Tracker{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/expenses.css" />
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Add New Expense</h5>
            </div>
            <div class="card-body">
                <form id="expenseForm">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input
                            type="number"
                            class="form-control"
                            id="amount"
                            step="0.01"
                            required
                        />
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" required>
                            <option value="Food">Food</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Bills">Bills</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" />
                    </div>
                    <div class="mb-3">
                        <label for="datetime" class="form-label">Date</label>
                        <input
                            type="date"
                            class="form-control"
                            id="datetime"
                            required
                            max=""
                        />
                    </div>
                    <button type="submit" class="btn btn-primary">Add Expense</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Bulk Upload</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-primary" id="downloadTemplate">
                        Download Template
                    </button>
                </div>
                <div class="mb-3">
                    <label class="btn btn-primary mb-0">
                        Upload Template
                        <input type="file" id="uploadTemplate" accept=".xlsx, .xls" hidden />
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Filter Expenses</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="searchInput" class="form-label">Search Description</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="filterCategory" class="form-label">Category</label>
                            <select class="form-select" id="filterCategory">
                                <option value="">All Categories</option>
                                <option value="Food">Food</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Bills">Bills</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="filterMonth" class="form-label">Month</label>
                            <input type="month" class="form-control" id="filterMonth">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button class="btn btn-primary" id="bulkShareButton" data-bs-toggle="modal" data-bs-target="#bulkShareModal">
                                    Share Selected
                                </button>
                                <button class="btn btn-danger" id="deleteSelected">
                                    Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Expenses Table -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Expenses List</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareUsername" class="form-label">Share with User</label>
                    <select class="form-select" id="shareUsername"></select>
                </div>
                <input type="hidden" id="expenseIdToShare">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="shareButton">Share</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Share Modal -->
<div class="modal fade" id="bulkShareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Multiple Expenses</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="bulkShareUsername" class="form-label">Share with User</label>
                    <select class="form-select" id="bulkShareUsername"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="bulkShareButton">Share</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    $(document).ready(function() {
        // Set default date to today
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;
        
        document.getElementById('datetime').value = formattedDate;
        document.getElementById('datetime').max = formattedDate;

        // Set default month filter to current month
        const currentMonth = `${year}-${month}`;
        document.getElementById('filterMonth').value = currentMonth;

        // Load expenses on page load
        loadExpenses();

        // Handle form submission
        $('#expenseForm').on('submit', function(e) {
            e.preventDefault();
            
            const amount = $('#amount').val();
            const category = $('#category').val();
            const description = $('#description').val();
            const date = $('#datetime').val();

            $.ajax({
                url: '/api/expenses',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    amount: parseFloat(amount),
                    category: category,
                    description: description,
                    date: date
                }),
                success: function(response) {
                    alert('Expense added successfully!');
                    $('#expenseForm')[0].reset();
                    document.getElementById('datetime').value = formattedDate;
                    loadExpenses();
                },
                error: function(xhr) {
                    alert('Failed to add expense: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        });

        // Download template
        $('#downloadTemplate').on('click', function() {
            const template = [
                {
                    date: formattedDate,
                    category: 'Food',
                    description: 'Example expense',
                    amount: 0
                }
            ];

            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'expense_template.xlsx');
        });

        // Handle file upload
        $('#uploadTemplate').on('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    // Validate data
                    const validRows = [];
                    const errors = [];

                    jsonData.forEach((row, index) => {
                        if (!row.date || !row.category || !row.amount) {
                            errors.push(`Row ${index + 1}: Missing required fields`);
                            return;
                        }

                        // Validate date
                        if (!isValidDate(row.date)) {
                            errors.push(`Row ${index + 1}: Invalid date format. Use YYYY-MM-DD`);
                            return;
                        }

                        // Validate category
                        if (!['Food', 'Transportation', 'Entertainment', 'Shopping', 'Bills', 'Other'].includes(row.category)) {
                            errors.push(`Row ${index + 1}: Invalid category`);
                            return;
                        }

                        // Validate amount
                        const amount = parseFloat(row.amount);
                        if (isNaN(amount) || amount <= 0) {
                            errors.push(`Row ${index + 1}: Invalid amount`);
                            return;
                        }

                        validRows.push({
                            date: formatDate(row.date),
                            category: row.category,
                            description: row.description || '',
                            amount: amount
                        });
                    });

                    if (errors.length > 0) {
                        alert('Upload failed:\n\n' + errors.join('\n'));
                        $('#uploadTemplate').val('');
                        return;
                    }

                    if (validRows.length === 0) {
                        alert('No valid data found in the file');
                        $('#uploadTemplate').val('');
                        return;
                    }

                    // Upload valid data
                    $.ajax({
                        url: '/api/expenses/bulk',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(validRows),
                        success: function(response) {
                            alert(`Successfully uploaded ${validRows.length} expenses!`);
                            $('#uploadTemplate').val('');
                            loadExpenses();
                        },
                        error: function(xhr) {
                            alert('Failed to upload expenses: ' + (xhr.responseJSON?.error || 'Unknown error'));
                            $('#uploadTemplate').val('');
                        }
                    });
                } catch (error) {
                    alert('Error processing file: ' + error.message);
                    $('#uploadTemplate').val('');
                }
            };

            reader.readAsArrayBuffer(file);
        });

        // Filter and search functionality
        function filterAndSearchExpenses() {
            const searchValue = $('#searchInput').val().toLowerCase();
            const selectedCategory = $('#filterCategory').val();
            const selectedMonth = $('#filterMonth').val();

            const filteredExpenses = currentExpenses.filter(expense => {
                const matchesSearch = expense.description.toLowerCase().includes(searchValue);
                const matchesCategory = !selectedCategory || expense.category === selectedCategory;
                const matchesMonth = !selectedMonth || expense.date.startsWith(selectedMonth);
                return matchesSearch && matchesCategory && matchesMonth;
            });

            updateExpenseTable(filteredExpenses);
        }

        // Event listeners for search and filters
        $('#searchInput').on('input', filterAndSearchExpenses);
        $('#filterCategory').on('change', filterAndSearchExpenses);
        $('#filterMonth').on('change', filterAndSearchExpenses);

        // Multi-select functionality
        $('#selectAll').on('change', function() {
            const isChecked = $(this).is(':checked');
            $('#expenseTableBody input[type="checkbox"]').prop('checked', isChecked);
        });

        // Delete selected expenses
        $('#deleteSelected').on('click', function() {
            const selectedIds = $('#expenseTableBody input[type="checkbox"]:checked')
                .map(function() {
                    return $(this).data('id');
                })
                .get();

            if (selectedIds.length === 0) {
                alert('No expenses selected');
                return;
            }

            if (!confirm('Are you sure you want to delete the selected expenses?')) {
                return;
            }

            $.ajax({
                url: '/api/expenses/bulk-delete',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ids: selectedIds }),
                success: function() {
                    loadExpenses();
                },
                error: function(xhr) {
                    alert('Error deleting expenses: ' + xhr.responseJSON?.error);
                }
            });
        });

        // Share functionality
        function loadUsernames() {
            $.ajax({
                url: '/api/users',
                method: 'GET',
                success: function(data) {
                    const select = $('#shareUsername');
                    const bulkSelect = $('#bulkShareUsername');
                    select.empty();
                    bulkSelect.empty();

                    data.forEach(function(user) {
                        const option = $('<option></option>')
                            .attr('value', user.username)
                            .text(user.username);
                        select.append(option);
                        bulkSelect.append(option.clone());
                    });
                },
                error: function(xhr) {
                    alert('Failed to load usernames');
                }
            });
        }

        // Load usernames when modals are shown
        $('#shareModal, #bulkShareModal').on('show.bs.modal', loadUsernames);

        // Share single expense
        $('#shareButton').on('click', function() {
            const username = $('#shareUsername').val();
            const expenseId = $('#expenseIdToShare').val();

            $.ajax({
                url: `/api/expenses/${expenseId}/share`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ username: username }),
                success: function() {
                    $('#shareModal').modal('hide');
                    alert('Expense shared successfully!');
                },
                error: function(xhr) {
                    alert('Error sharing expense: ' + xhr.responseJSON?.error);
                }
            });
        });

        // Share multiple expenses
        $('#bulkShareButton').on('click', function() {
            const selectedIds = $('#expenseTableBody input[type="checkbox"]:checked')
                .map(function() {
                    return $(this).data('id');
                })
                .get();

            if (selectedIds.length === 0) {
                alert('No expenses selected');
                return;
            }

            const username = $('#bulkShareUsername').val();
            if (!username) {
                alert('Please select a user to share with');
                return;
            }

            $.ajax({
                url: '/api/expenses/bulk-share',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ids: selectedIds, username: username }),
                success: function() {
                    $('#bulkShareModal').modal('hide');
                    alert('Expenses shared successfully!');
                },
                error: function(xhr) {
                    alert('Error sharing expenses: ' + xhr.responseJSON?.error);
                }
            });
        });
    });

    // Helper functions
    function isValidDate(dateStr) {
        if (!dateStr) return false;
        const regex = /^\d{4}-\d{2}-\d{2}$/;
        if (!regex.test(dateStr)) return false;
        const date = new Date(dateStr);
        return date instanceof Date && !isNaN(date);
    }

    function formatDate(dateStr) {
        if (typeof dateStr === 'number') {
            // Handle Excel date format
            const date = new Date((dateStr - 25569) * 86400 * 1000);
            return date.toISOString().split('T')[0];
        }
        return dateStr;
    }

    let currentExpenses = [];

    function loadExpenses() {
        $.get('/api/expenses', function(expenses) {
            currentExpenses = expenses;
            filterAndSearchExpenses();
        });
    }

    function updateExpenseTable(expenses) {
        const tbody = $('#expenseTableBody');
        tbody.empty();

        expenses.forEach(expense => {
            const row = `
                <tr>
                    <td><input type="checkbox" data-id="${expense.id}"></td>
                    <td>${expense.date}</td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td>$${expense.amount.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openShareModal(${expense.id})">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteExpense(${expense.id})">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    function openShareModal(expenseId) {
        $('#expenseIdToShare').val(expenseId);
        $('#shareModal').modal('show');
    }

    function deleteExpense(expenseId) {
        if (!confirm('Are you sure you want to delete this expense?')) {
            return;
        }

        $.ajax({
            url: '/api/expenses/delete',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ id: expenseId }),
            success: function() {
                loadExpenses();
            },
            error: function(xhr) {
                alert('Error deleting expense: ' + xhr.responseJSON?.error);
            }
        });
    }
</script>
{% endblock %} 