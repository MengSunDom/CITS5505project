{% extends "base.html" %} {% block title %}Login - Expense Tracker{% endblock %} {% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="text-center">Login</h3>
            </div>
            <div class="card-body">
                <form id="loginForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input
                            type="text"
                            class="form-control"
                            id="username"
                            name="username"
                            required
                        />
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input
                            type="password"
                            class="form-control"
                            id="password"
                            name="password"
                            required
                        />
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe">
                        <label class="form-check-label" for="rememberMe">Remember me</label>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                </form>
                <div class="text-center mt-3">
                    <p>Don't have an account? <a href="/register">Register here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
    $(document).ready(function() {
        // Check if there are saved credentials
        const savedUsername = localStorage.getItem('username');
        const savedPassword = localStorage.getItem('password');
        
        if (savedUsername && savedPassword) {
            $('#username').val(savedUsername);
            $('#password').val(savedPassword);
            $('#rememberMe').prop('checked', true);
        }

        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            
            const username = $('#username').val();
            const password = $('#password').val();
            const rememberMe = $('#rememberMe').is(':checked');
            const csrfToken = $('input[name="csrf_token"]').val();

            // Show loading state
            const submitButton = $(this).find('button[type="submit"]');
            const originalText = submitButton.text();
            submitButton.prop('disabled', true).text('Logging in...');

            $.ajax({
                url: '/login',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    username: username,
                    password: password,
                    csrf_token: csrfToken
                }),
                success: function(response) {
                    if (rememberMe) {
                        localStorage.setItem('username', username);
                        localStorage.setItem('password', password);
                    } else {
                        localStorage.removeItem('username');
                        localStorage.removeItem('password');
                    }
                    window.location.href = '/dashboard';
                },
                error: function(xhr) {
                    submitButton.prop('disabled', false).text(originalText);
                    
                    let errorMessage = 'Login failed: ';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage += xhr.responseJSON.error;
                    } else if (xhr.status === 401) {
                        errorMessage += 'Invalid username or password';
                    } else if (xhr.status === 403) {
                        errorMessage += 'CSRF token validation failed';
                    } else {
                        errorMessage += 'Server error occurred';
                    }
                    
                    alert(errorMessage);
                    console.error('Login error:', xhr);
                }
            });
        });
    });
</script>
{% endblock %}
